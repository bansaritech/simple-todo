<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Title -->
    <title>Whatsapp Msg</title>

    <!-- Meta Informations -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Send whatsapp message, without saving the contact number">
    <meta name="keywords" content="Direct message, whatsapp message, whatsapp, message, without save">
    <meta name="author" content="Harikrushna V. Adiecha">

    <!-- Links -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon.png">
    <link rel="shortcut icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="//unpkg.com/alpinejs" defer></script>

</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">
    <div x-data="todoApp()" x-init="init()">
        <h1 class="text-3xl text-center mb-3">ToDo</h1>
        <div class="max-w-md w-full p-4 bg-white shadow-md rounded-md">
            <template x-for="(todo, index) in todos" :key="index">
                <div class="flex flex-row items-center space-x-2 mb-4">
                    <button @click="removeTodo(index)" class="bg-gray-200 py-2 rounded-md hover:bg-red-300 hover:text-white transition-all px-4">
                        üóëÔ∏è
                    </button>
                    <input x-model="todo.content" type="text" placeholder="" class="p-2 border rounded-md focus:outline-none focus:ring focus:border-blue-400 w-full">
                    <span class="bg-gray-200 text-gray-600 py-2 rounded-md transition-all px-4" x-text="timeTxt[index]">
                    </span>
                    <template x-if="!todo.started_at || todo.started_at == null">
                        <button @click="startTodo(todo)" class="bg-transparent text-gray-800 rounded-md transition-all px-2 text-4xl">
                            ‚ñ∂Ô∏è
                        </button>
                    </template>
                    <template x-if="todo.started_at > 0">
                        <button @click="stopTodo(todo)" class="bg-transparent text-gray-800 rounded-md transition-all px-2 text-4xl">
                            ‚èπÔ∏è
                        </button>
                    </template>

                </div>
            </template>

            <div class="flex flex-row items-center justify-between gap-x-2">
                <button @click="clearAll()" class="bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition-all px-4">All Clear</button>
                <button @click="addTodo()" class="bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition-all px-4">Add</button>
            </div>
        </div>
    </div>
    
    <script>
    function todoApp() {
        return {

            todos: [],
            currentTime: Date.now(),

            // Initialize the data from local storage if available
            init() {
                const savedTodos = JSON.parse(localStorage.getItem('todos'));
                if (savedTodos) {
                    this.todos = savedTodos;
                }
                this.startTimer();
            },

            // This function will update currentTime every second using x-effect
            startTimer() {
                // Create an interval that will update the currentTime every second
                setInterval(() => {
                    this.currentTime = Date.now(); // Update the current time every second
                }, 1000);
            },

            // Add a new todo item
            addTodo() {
                newTodo = prompt('Enter new todo')
                if (newTodo.trim() === '') return;
                this.todos.push({
                    content: newTodo.trim(),
                    slots: []
                });
                this.saveToLocalStorage();
            },

            clearAll() {
                this.todos = [];
                localStorage.removeItem('todos')
            },

            // Remove a todo item
            removeTodo(index) {
                this.todos.splice(index, 1);
                this.saveToLocalStorage();
            },

            startTodo(todo) {
                this.todos.filter(t => t.started_at && t != todo).forEach(t => this.stopTodo(t))
                todo.started_at = Date.now()
                this.saveToLocalStorage();
            },

            stopTodo(todo) {
                todo.slots.push({
                    from: todo.started_at,
                    to: Date.now()
                })
                todo.started_at = null
                // this.todos.splice(index, 1);
                this.saveToLocalStorage();
            },

            get timeTxt() {
                return this.todos.map((todo) => {
                    const prev = todo.slots.map((s) => s.to - s.from).reduce((c, i) => c + i, 0);
                    const td = prev + ((!todo.started_at) ? 0 : (this.currentTime - todo.started_at));
                    // console.log(prev, td, prev + td)
                    const hh = Math.floor(td / (1000 * 60 * 60)); // 1 hour = 1000 * 60 * 60 milliseconds
                    const mm = Math.floor((td % (1000 * 60 * 60)) / (1000 * 60)); // 1 minute = 1000 * 60 milliseconds
                    const ss = Math.floor((td % (1000 * 60)) / 1000);
                    // Format hours and minutes as "hh:mm"
                    return `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}`;
                    
                })
            },

            // Save todos to local storage
            saveToLocalStorage() {
                localStorage.setItem('todos', JSON.stringify(this.todos));
            }
        };
    }
    </script>
</body>
</html>
